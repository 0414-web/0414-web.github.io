<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>문경 학사 식사 신청</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9fafb; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1"
    }
  }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="pb-20">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import { ChevronLeft, ChevronRight, Check } from 'lucide-react';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // --- [Firebase keycode] ---
    // Firebase 콘솔에서 복사한 내용
  const firebaseConfig = {
    apiKey: "AIzaSyCwIp4CA2P41CBOzirB6dTrOTzMO4DWYpA",
    authDomain: "list-03-1efd8.firebaseapp.com",
    projectId: "list-03-1efd8",
    storageBucket: "list-03-1efd8.firebasestorage.app",
    messagingSenderId: "73291844896",
    appId: "1:73291844896:web:802e4821e16313eee0db45"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 데이터 설정 ---
    const TIME_SLOTS = ['아침(07:00)', '점심(12:00)', '저녁(19:00)'];
    
    // 사용자 목록 (필요에 따라 수정하세요)
    const MALE_NAMES = ['철수', '영희', '바둑이', '호날두', 'ㄱㄱㄱ', 'ㄱㄱㄴ', 'ㄱㄱㄷ', 'ㄱㄱㅁ', 'ㄱㄱㄹ', 'ㄱㄱㅂ', 'ㄱㄱㅅ', 'ㄱㄱㅇ', 'ㄱㄱㅈ', 'ㄱㄱㅊ', 'ㄱㄱㅋ', 'ㄱㄱㅌ', 'ㄱㄱㅍ', 'ㄱㄱㅎ'];
    const FEMALE_NAMES = ['ㅇㅇㅇ', 'ㅇㅇㄹ', 'ㅇㅇㅎ', 'ㅇㅇㄱ', 'ㅇㅇㄷ', 'ㅇㅇㅈ', 'ㅇㅇㅂ', 'ㅇㅇㅁ', 'ㅇㅇㄴ', 'ㅇㅇㅋ', 'ㅇㅇㅌ', 'ㅇㅇㅊ', 'ㅇㅇㅍ', 'ㅎㅎㅇ', 'ㅎㅎㄱ', 'ㅎㅎㄴ', 'ㅎㅎㅌ'];

    const createUsers = (names, gender) => names.map((name, i) => ({
      id: `${gender}-${i}`, name, gender,
      avatarColor: gender === 'male' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'
    }));

    const USERS = [
      ...createUsers(MALE_NAMES, 'male'),
      ...createUsers(FEMALE_NAMES, 'female')
    ];

    // --- 유틸리티 ---
    const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const getWeekDays = (start) => Array.from({length:7}, (_, i) => { const d = new Date(start); d.setDate(start.getDate() + i); return d; });

    // --- 마감 로직 ---
    const isRegistrationClosed = (dateStr, slot) => {
      const now = new Date();
      const todayStr = formatDate(now);
      if (dateStr < todayStr) return true;
      if (dateStr > todayStr) return false;
      
      const hour = now.getHours();
      if (slot.includes('아침')) return hour >= 5;
      if (slot.includes('점심')) return hour >= 10;
      if (slot.includes('저녁')) return hour >= 17;
      return false;
    };

    // --- 컴포넌트 ---
    const WeekCalendar = ({ selectedDate, onSelectDate, startDate, setStartDate }) => {
      const days = getWeekDays(startDate);
      const moveWeek = (d) => { const n = new Date(startDate); n.setDate(startDate.getDate() + d); setStartDate(n); };

      return (
        <div className="bg-white shadow-sm border-b sticky top-0 z-10">
          <div className="max-w-md mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <button onClick={() => moveWeek(-7)} className="p-1 hover:bg-gray-100 rounded-full"><ChevronLeft size={20}/></button>
              <h2 className="text-lg font-bold text-gray-800">{startDate.getMonth()+1}월 {Math.ceil(startDate.getDate()/7)}주차</h2>
              <button onClick={() => moveWeek(7)} className="p-1 hover:bg-gray-100 rounded-full"><ChevronRight size={20}/></button>
            </div>
            <div className="flex justify-between overflow-x-auto scrollbar-hide gap-2 pb-2">
              {days.map(d => {
                const fullDate = formatDate(d);
                const isSel = selectedDate === fullDate;
                const dayName = ['일','월','화','수','목','금','토'][d.getDay()];
                const color = d.getDay()===0 ? 'text-red-500' : d.getDay()===6 ? 'text-blue-500' : 'text-gray-600';
                return (
                  <button key={fullDate} onClick={() => onSelectDate(fullDate)} 
                    className={`flex flex-col items-center min-w-[3.5rem] py-3 rounded-2xl transition-all ${isSel ? 'bg-indigo-600 scale-105 shadow-md' : 'bg-gray-50'}`}>
                    <span className={`text-xs mb-1 ${isSel ? 'text-indigo-200' : 'text-gray-400'}`}>{dayName}</span>
                    <span className={`text-lg font-bold ${isSel ? 'text-white' : color}`}>{d.getDate()}</span>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    const DailyTable = ({ data, selectedDate, onToggle }) => {
      const stats = useMemo(() => {
        const s = {};
        TIME_SLOTS.forEach(slot => s[slot] = { total: 0, male: 0, female: 0 });
        USERS.forEach(u => {
          TIME_SLOTS.forEach(slot => {
            if (data[u.name]?.[slot]) { s[slot].total++; u.gender==='male' ? s[slot].male++ : s[slot].female++; }
          });
        });
        return s;
      }, [data]);

      return (
        <div className="space-y-4">
          <div className="grid grid-cols-3 gap-2">
            {TIME_SLOTS.map(slot => (
              <div key={slot} className="bg-white p-3 rounded-xl border shadow-sm text-center">
                <div className="text-xs font-bold text-gray-500 mb-1">{slot.split('(')[0]}</div>
                <div className="text-xl font-extrabold text-gray-800 mb-2">{stats[slot].total}</div>
                <div className="text-[11px] font-medium space-x-1">
                  <span className="text-blue-500 bg-blue-50 px-1 rounded">남 {stats[slot].male}</span>
                  <span className="text-pink-500 bg-pink-50 px-1 rounded">여 {stats[slot].female}</span>
                </div>
              </div>
            ))}
          </div>

          <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm min-w-[320px]">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-3 py-3 w-24 text-center">이름</th>
                    {TIME_SLOTS.map(s => <th key={s} className="px-1 text-center min-w-[60px]">{s.split('(')[0]}</th>)}
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {USERS.map(user => (
                    <tr key={user.id} className="hover:bg-gray-50">
                      <td className="px-3 py-2 text-center font-semibold">
                        <span className={user.gender==='male'?'text-blue-900':'text-pink-900'}>{user.name}</span>
                      </td>
                      {TIME_SLOTS.map(slot => {
                        const isSel = data[user.name]?.[slot];
                        const closed = isRegistrationClosed(selectedDate, slot);
                        let btnClass = `w-full h-10 rounded-lg flex items-center justify-center transition-all ${
                          closed ? 'cursor-not-allowed opacity-50 ' + (isSel ? (user.gender==='male'?'bg-blue-500 text-white':'bg-pink-500 text-white') : 'bg-gray-100') :
                          isSel ? (user.gender==='male'?'bg-blue-500 text-white active:scale-95':'bg-pink-500 text-white active:scale-95') : 'bg-gray-50 hover:bg-gray-100 active:scale-95'
                        }`;
                        return (
                          <td key={slot} className="p-1">
                            <button onClick={() => !closed && onToggle(user.name, slot, isSel)} disabled={closed} className={btnClass}>
                              {isSel ? <Check size={18} strokeWidth={3}/> : <div className="w-1.5 h-1.5 rounded-full bg-gray-200"/>}
                            </button>
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    // --- 메인 앱 ---
    const App = () => {
      const [date, setDate] = useState(formatDate(new Date()));
      const [weekStart, setWeekStart] = useState(new Date());
      const [data, setData] = useState({});

      useEffect(() => {
        const unsub = onSnapshot(doc(db, "daily_meals", date), (s) => setData(s.exists() ? s.data() : {}));
        return () => unsub();
      }, [date]);

      const toggle = async (name, slot, val) => {
        if (isRegistrationClosed(date, slot)) return alert('마감되었습니다.');
        try {
          await setDoc(doc(db, "daily_meals", date), { [name]: { [slot]: !val } }, { merge: true });
        } catch (e) { console.error(e); alert('오류가 발생했습니다.'); }
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="bg-white px-6 pt-10 pb-4 border-b sticky top-0 z-20 shadow-sm">
            <h1 className="text-2xl font-extrabold text-gray-900">문경 학사 식사 신청</h1>
          </header>
          <WeekCalendar selectedDate={date} onSelectDate={setDate} startDate={weekStart} setStartDate={setWeekStart} />
          <main className="max-w-md mx-auto px-4 py-6">
            <DailyTable data={data} selectedDate={date} onToggle={toggle} />
          </main>
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
